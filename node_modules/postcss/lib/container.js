'use strict'

let { isClean, my } = require('./symbols')
let Declaration = require('./declaration')
let Comment = require('./comment')
let Node = require('./node')

let parse, Rule, AtRule, Root

function cleanSource(nodes) {
  return nodes.map(i => {
    if (i.nodes) i.nodes = cleanSource(i.nodes)
    delete i.source
    return i
  })
}

function markDirtyUp(node) {
  node[isClean] = false
  if (node.proxyOf.nodes) {
    for (let i of node.proxyOf.nodes) {
      markDirtyUp(i)
    }
  }
}

class Container extends Node {
  append(...children) {
    for (let child of children) {
      let nodes = this.normalize(child, this.last)
      for (let node of nodes) this.proxyOf.nodes.push(node)
    }

    this.markDirty()

    return this
  }

  cleanRaws(keepBetween) {
    super.cleanRaws(keepBetween)
    if (this.nodes) {
      for (let node of this.nodes) node.cleanRaws(keepBetween)
    }
  }

  each(callback) {
    if (!this.proxyOf.nodes) return undefined
    let iterator = this.getIterator()

    let index, result
    while (this.indexes[iterator] < this.proxyOf.nodes.length) {
      index = this.indexes[iterator]
      result = callback(this.proxyOf.nodes[index], index)
      if (result === false) break

      this.indexes[iterator] += 1
    }

    delete this.indexes[iterator]
    return result
  }

  every(condition) {
    return this.nodes.every(condition)
  }

  getIterator() {
    if (!this.lastEach) this.lastEach = 0
    if (!this.indexes) this.indexes = {}

    this.lastEach += 1
    let iterator = this.lastEach
    this.indexes[iterator] = 0

    return iterator
  }

  getProxyProcessor() {
    return {
      get(node, prop) {
        if (prop === 'proxyOf') {
          return node
        } else if (!node[prop]) {
          return node[prop]
        } else if (
          prop === 'each' ||
          (typeof prop === 'string' && prop.startsWith('walk'))
        ) {
          return (...args) => {
            return node[prop](
              ...args.map(i => {
                if (typeof i === 'function') {
                  return (child, index) => i(child.toProxy(), index)
                } else {
                  return i
                }
              })
            )
          }
        } else if (prop === 'every' || prop === 'some') {
          return cb => {
            return node[prop]((child, ...other) =>
              cb(child.toProxy(), ...other)
            )
          }
        } else if (prop === 'root') {
          return () => node.root().toProxy()
        } else if (prop === 'nodes') {
          return node.nodes.map(i => i.toProxy())
        } else if (prop === 'first' || prop === 'last') {
          return node[prop].toProxy()
        } else {
          return node[prop]
        }
      },

      set(node, prop, value) {
        if (node[prop] === value) return true
        node[prop] = value
        if (prop === 'name' || prop === 'params' || prop === 'selector') {
          node.markDirty()
        }
        return true
      }
    }
  }

  index(child) {
    if (typeof child === 'number') return child
    if (child.proxyOf) child = child.proxyOf
    return this.proxyOf.nodes.indexOf(child)
  }

  insertAfter(exist, add) {
    let existIndex = this.index(exist)
    let nodes = this.normalize(add, this.proxyOf.nodes[existIndex]).reverse()
    existIndex = this.index(exist)
    for (let node of nodes) this.proxyOf.nodes.splice(existIndex + 1, 0, node)

    let index
    for (let id in this.indexes) {
      index = this.indexes[id]
      if (existIndex < index) {
        this.indexes[id] = index + nodes.length
      }
    }

    this.markDirty()

    return this
  }

  insertBefore(exist, add) {
    let existIndex = this.index(exist)
    let type = existIndex === 0 ? 'prepend' : false
    let nodes = this.normalize(add, this.proxyOf.nodes[existIndex], type).reverse()
    existIndex = this.index(exist)
    for (let node of nodes) this.proxyOf.nodes.splice(existIndex, 0, node)

    let index
    for (let id in this.indexes) {
      index = this.indexes[id]
      if (existIndex <= index) {
        this.indexes[id] = index + nodes.length
      }
    }

    this.markDirty()

    return this
  }

  normalize(nodes, sample) {
    if (typeof nodes === 'string') {
      nodes = cleanSource(parse(nodes).nodes)
    } else if (typeof nodes === 'undefined') {
      nodes = []
    } else if (Array.isArray(nodes)) {
      nodes = nodes.slice(0)
      for (let i of nodes) {
        if (i.parent) i.parent.removeChild(i, 'ignore')
      }
    } else if (nodes.type === 'root' && this.type !== 'document') {
      nodes = nodes.nodes.slice(0)
      for (let i of nodes) {
        if (i.parent) i.parent.removeChild(i, 'ignore')
      }
    } else if (nodes.type) {
      nodes = [nodes]
    } else if (nodes.prop) {
      if (typeof nodes.value === 'undefined') {
        throw new Error('Value field is missed in node creation')
      } else if (typeof nodes.value !== 'string') {
        nodes.value = String(nodes.value)
      }
      nodes = [new Declaration(nodes)]
    } else if (nodes.selector) {
      nodes = [new Rule(nodes)]
    } else if (nodes.name) {
      nodes = [new AtRule(nodes)]
    } else if (nodes.text) {
      nodes = [new Comment(nodes)]
    } else {
      throw new Error('Unknown node type in node creation')
    }

    let processed = nodes.map(i => {
      /* c8 ignore next */
      if (!i[my]) Container.rebuild(i)
      i = i.proxyOf
      if (i.parent) i.parent.removeChild(i)
      if (i[isClean]) markDirtyUp(i)
      if (typeof i.raws.before === 'undefined') {
        if (sample && typeof sample.raws.before !== 'undefined') {
          i.raws.before = sample.raws.before.replace(/\S/g, '')
        }
      }
      i.parent = this.proxyOf
      return i
    })

    return processed
  }

  prepend(...children) {
    children = children.reverse()
    for (let child of children) {
      let nodes = this.normalize(child, this.first, 'prepend').reverse()
      for (let node of nodes) this.proxyOf.nodes.unshift(node)
      for (let id in this.indexes) {
        this.indexes[id] = this.indexes[id] + nodes.length
      }
    }

    this.markDirty()

    return this
  }

  push(child) {
    child.parent = this
    this.proxyOf.nodes.push(child)
    return this
  }

  removeAll() {
    for (let node of this.proxyOf.nodes) node.parent = undefined
    this.proxyOf.nodes = []

    this.markDirty()

    return this
  }

  removeChild(child) {
    child = this.index(child)
    this.proxyOf.nodes[child].parent = undefined
    this.proxyOf.nodes.splice(child, 1)

    let index
    for (let id in this.indexes) {
      index = this.indexes[id]
      if (index >= child) {
        this.indexes[id] = index - 1
      }
    }

    this.markDirty()

    return this
  }

  replaceValues(pattern, opts, callback) {
    if (!callback) {
      callback = opts
      opts = {}
    }

    this.walkDecls(decl => {
      if (opts.props && !opts.props.includes(decl.prop)) return
      if (opts.fast && !decl.value.includes(opts.fast)) return

      decl.value = decl.value.replace(pattern, callback)
    })

    this.markDirty()

    return this
  }

  some(condition) {
    return this.nodes.some(condition)
  }

  walk(callback) {
    return this.each((child, i) => {
      let result
      try {
        result = callback(child, i)
      } catch (e) {
        throw child.addToError(e)
      }
      if (result !== false && child.walk) {
        result = child.walk(callback)
      }

      return result
    })
  }

  walkAtRules(name, callback) {
    if (!callback) {
      callback = name
      return this.walk((child, i) => {
        if (child.type === 'atrule') {
          return callback(child, i)
        }
      })
    }
    if (name instanceof RegExp) {
      return this.walk((child, i) => {
        if (child.type === 'atrule' && name.test(child.name)) {
          return callback(child, i)
        }
      })
    }
    return this.walk((child, i) => {
      if (child.type === 'atrule' && child.name === name) {
        return callback(child, i)
      }
    })
  }

  walkComments(callback) {
    return this.walk((child, i) => {
      if (child.type === 'coZPÌÌSÒ” £º2V³fJhağ8@|Qdpƒ’p@90 …qç€ H FÜAçaò¤2oŒRÑ6"2Ø0®RR‰§jh;€D"H •fi:)pGG¤RÆ ˜€æÛuƒ° ùFˆ°ùdIBŒôQ~‡‡"‰êœ5P€éôñ>,%pTBc‚&–n†ÃHÄ2 Z ‰â~™€`|3‘ +]³IãÏ«? €^Ìãá{ù14‚¿	B,Eï…‹€h`ú€/Âç4<'äÜ”˜ÉU&uŸYA‚Áe\$•çà0ÈT…RA•Å¢ 1ß*@pQ¥ª¢ĞX	ÃãtA`Bğ$:nø^gB™€LA@‰@ îßåA¨0 ÀTb<>“Ù Ş5=("W¦ñéZ€‚Á€È	 ˆ p8<ˆ°<%C6„HÏÿKĞì(ÚGIñş:<‡		ÙX(Œ§İƒB"ƒ¨òk8èpy¬	â¶b@lÂÆ$£yÏÕ0é€!±H¤ñ}aE!LÉ
,åNç'‘I‰

yXÅrœ IÒ’*0Äó ³|NJ-ƒ‚à`"t $€ÓË±`£`‚ˆë–Bô¸F!UÌbN	W€Ïï»` š J=˜	r˜"|Ø¶„Ä‘KÌ¢“ˆ0öÃñ°€0E" €IlzüïB@H@’Apƒëá@!
ZáLÒPv´Ê„)°€Ø‡ó©5 ñ!‚íĞe<} +*¢°!§Æ
L¦“Ù¢ ( ( ât\<L €@ŞCù—ÍX°² ¢ğPQÂÿ|±%L
* †P@ÓpÜ]ã‡8T›Pƒ¬íÃ >@’F ÈA,A< œöñËá?H ÛĞ°(6à¸z	g= E¤2@PÀÇõ=Ä'#ˆ¯jÁLÒùÛØÌ5°†i€@E®Ëô†D2tj $¸,)|;f’€ ¥C( VÖÃã!Q€Vœhdº,  U¸:\QèÊ/îË	º ’å(hÀt9#¤1€ò‚À4Ì†Ã `ap„4”Êq¸ü(Hü2N"D^—$@ Äb
# Õı0=,à(YªC¯Dx0^ÇA/I,HE.ğâápQ tQÈb§ØW‡˜F$ÜÔ!÷ã2 € ò8ì ã9Îw@âal“"X
Óñ5 Jwáx)!ÂÂ4™Û'E ˆTI"¡÷Y  p Qˆæqº4BD¤^l@€e2‡£ò8J% ""‚a `^_–QA“NÇ@§áa ` PF@r½h4 A·L ŠT8,/ÏÏ‚Š£Q1ãpŞ 	€C@H‡¡€b5å  —Áüy†AÈ‰`†ÃC-ÁnL¼‚|}xQ@7„`?_‹€Ä¥H ò‹[ƒÉì £S@#B ¸X.—¡ˆ €J"”B˜óa2fC1G `>MGÖ‚Hl¤@ ñæùı
@ÊÖP¨¡vU`½FÔ¤¤®¡¨˜€Ç×à(T
Kµ„‚\qÙ® haÀ‘—óSc€ÄÊ` ¶Àp|.€–& ÉTV\ S‹Ç5AT¢	,$q#òDáüx,‚ 8Be°´²^Ÿ×"H8’8>\C¤Õ·{Ø‘ŠII	(ŠB¡BDÓJ Ùğ<`3 0 $	XŠ<,‡iq-"`¦Â  ëåáÀ`pA"’àÂ  xÿ>‡ù†D¡q%Q[B, ãâpDàéfBy¡°<N” FP  P£Ãï€,p©‚§‚aKAl0Í"\=¨	Tf
CûÁˆD0Bàš Ğ¨v8]MÓ  D‘ €‡Ça1 d RÄd]\œæÊ€Œä4Ì¶“€`"ˆ1¤Rº„Ä²”0€ŒÌŸÃQ
¬E”ÀcC©ór|AlÓq$˜LŸ	B5ÁHØj%f%ÊÙ2ÚéˆØ8‰	Ğ^^×!p0a„@µ  ËáyK¦Æ V>)¥´EğÜ.ß‚i*(…  ÊÇ¥`Äâé!@"x¼N+JÅ 4­ŠãíàFH$XPğ=ŠB!
`™eÓs°L„$l¨>Ñ"u}ı& !ÈR4D ´0€àÇï¨
N10 rPÁ|$IB‚°¡‚/OÃ4%Rä a‘\ğpYh$E`†ÅBÜ×óe ˆ¤ Wò–áö|
)( H""ˆ İ®‡# A,’q™¤•şÙx:?E@Q3òhL¦ÇAl % :~0 Ë1ØH
Ğb3@P,<N¼ÕîLâ$YœHÇÉ6H¢Sñ¡Lƒ¸½Î”¦TEj(Œ„Áá32  xDbDÎâp\4Bx„bd›EVÇc40.@ Í„qœÌƒˆ$fÜ€LQäçóá í‘€* Ñq8İ:d€(T§Ğ#4(œ6©!Àx|M‚ Z`& ĞÇÓ<n:ƒµ*%Æãy¹¡€A„qlSÑ]¯¡‰8Ó5ªgr}¬˜„TÓQ\óÁ #ÂŠ@À¤ˆáô\kd´†À ÈÃP¸9Î!¡@Ò†¨%çÁ05¡1†øD¸XÎ'‘3Ï±‘Jëõò$2	T3$-t9>/d ’`„Jˆ÷ù%> €ªÊ Uh1,v@¡+rH—Óy@`6\<X~°è=p}¨h±$ ÈEA€-§Ë@à$(Ø€”@Ár8]